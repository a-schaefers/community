#!/bin/sh -e

if [ ! -f "/etc/rc.conf" ]; then
    cat << EOF && exit 1
################################################################################
# Please upgrade to latest baseinit and try installing sinit again... Thank You.
################################################################################
EOF
fi

# be explicitly static for pid 1
make CFLAGS="$CFLAGS -static"

install -Dm 755 sinit "$1/usr/bin/sinit"

# /etc/rc.d scripts
install -Dm 755 sinit_runit.sh "$1/etc/rc.d/sinit_runit.sh"
install -Dm 755 sinit_getty.sh "$1/etc/rc.d/sinit_getty.sh"
install -Dm 755 rc.shutdown_pre-sinit "$1/etc/rc.d/rc.shutdown_pre-sinit"
install -Dm 755 rc.shutdown_post-sinit "$1/etc/rc.d/rc.shutdown_post-sinit"

# If this is a first time sinit install let's populate /etc/rc.conf with
# some sane configuration variables...
if [ -z "$(grep -q "SINIT_" /etc/rc.conf)" ];then
    cat << EOF >> /etc/rc.conf

# Uncomment and Set to 1 to enable /etc/rc.d/sinit_getty.sh
# Warning: [sinit / non-busybox init users only!!]
# SINIT_ENABLE_GETTY=1

# Uncomment and Set to 1 to enable /etc/rc.d/sinit_runit.sh
# Warning: [sinit / non-busybox init users only!!]
# SINIT_ENABLE_RUNIT=1

EOF
fi
